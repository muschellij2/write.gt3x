checksum_from_header = function(header) {
  out = header
  result = as.raw(0x0)
  for (iout in 1:length(out)) {
    result = xor(result, out[iout])
  }
  result = rawToBits(result)
  result = 1L - as.integer(result)
  as.raw(packBits(result))
}

create_meta_packet = function(subject_name = "FAKEGT3X") {
  values = list(
    MetadataType = "Bio",
    SubjectName = subject_name,
    Gender = "",
    Race = "",
    Limb = "Wrist",
    Side = "Left",
    Dominance = "Non-Dominant",
    Parsed = FALSE,
    JSON = NA)
  packet = jsonlite::toJSON(values, auto_unbox = TRUE)
  packet = as.character(packet)
  payload = charToRaw(packet)

  packet_timestamp = lubridate::with_tz(Sys.time(), "GMT")
  packet_timestamp = as.integer(packet_timestamp)

  size = length(payload) # 2 bytes
  size = as.integer(size)
  checksum = 8L + size

  # writeBin("\x1e"
  header = c(
    # # log separator
    # writeBin("\x1e", raw(0), size=1L, endian="little"),
    # # ACTIVITY2 Packet
    # writeBin("\x1a", raw(0), size=1L, endian="little"),
    # log separator
    # writeBin("\x1e", raw(0), size=1L, endian="little", useBytes = TRUE)[1],
    as.raw(0x1e),
    # metadata
    as.raw(0x06),
    # writeBin("\x1e", raw(0), size=1L, endian="little", useBytes = TRUE)[1],
    # \x1a
    # timestamp
    # 1421142129L
    # writeBin(1490718600L, raw(0), size = 4L, endian = "little"),
    writeBin(packet_timestamp, raw(0), size = 4L, endian = "little"),
    # size in bytes
    writeBin(size, raw(0), size = 2L, endian = "little")[1:2],
    # payload/data
    # writeBin(payload, raw(0), endian = "little"),
    payload
    )
  checksum = writeBin(checksum_from_header(header), raw(0),
                      endian = "little", size = 1L)[1]
  header = c(
    header,
    checksum
  )

  return(packet)
}


# taken from https://github.com/actigraph/GT3X-File-Format/blob/main/LogRecords/Parameters.md
params_packet = function() {
  x = c(
    0x1E, 0x15, 0xF2, 0x24, 0xD2, 0x54, 0xA8, 0x01, 0x00, 0x00, 0x06, 0x00, 0x02, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x07, 0x00, 0x81, 0x95, 0x41, 0x03, 0x00, 0x00, 0x08, 0x00, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x09, 0x00, 0x27, 0xAA, 0x0D, 0x54, 0x00, 0x00, 0x0D, 0x00, 0x25, 0x00, 0x01, 0x01,
    0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x80, 0xE4, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1A, 0x00, 0x02, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x1C, 0x00, 0x7D, 0x01, 0x00, 0x00, 0x00, 0x00, 0x1D, 0x00, 0x07, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x20, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x25, 0x00, 0x00, 0x04, 0x00, 0x00,
    0x00, 0x00, 0x26, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x00, 0x00, 0x00, 0x40, 0x0C,
    0x00, 0x00, 0x32, 0x00, 0x37, 0x89, 0x41, 0x05, 0x00, 0x00, 0x33, 0x00, 0x07, 0x3A, 0x6D, 0x03,
    0x00, 0x00, 0x37, 0x00, 0x00, 0x00, 0x40, 0x09, 0x00, 0x00, 0x39, 0x00, 0xAE, 0x77, 0x53, 0x09,
    0x00, 0x00, 0x3A, 0x00, 0x00, 0x00, 0x54, 0x05, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x01, 0x00, 0x44, 0xD4, 0x12, 0xAF, 0x01, 0x00, 0x02, 0x00, 0x14, 0x01, 0x00, 0x00,
    0x01, 0x00, 0x03, 0x00, 0x07, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x49, 0xFF, 0xFF, 0xFF,
    0x01, 0x00, 0x05, 0x00, 0x1A, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x06, 0x00, 0x52, 0xFF, 0xFF, 0xFF,
    0x01, 0x00, 0x07, 0x00, 0x31, 0x01, 0x00, 0x00, 0x01, 0x00, 0x08, 0x00, 0x20, 0x01, 0x00, 0x00,
    0x01, 0x00, 0x09, 0x00, 0x24, 0x01, 0x00, 0x00, 0x01, 0x00, 0x0A, 0x00, 0x1E, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x0C, 0x00, 0xE0, 0x25, 0xD2, 0x54, 0x01, 0x00, 0x0D, 0x00, 0x70, 0x85, 0xD3, 0x54,
    0x01, 0x00, 0x0E, 0x00, 0xF2, 0x24, 0xD2, 0x54, 0x01, 0x00, 0x0F, 0x00, 0x44, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x10, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x01, 0x00, 0x11, 0x00, 0x3F, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x21, 0x00, 0x60, 0xEA, 0x00, 0x00, 0x01, 0x00, 0x22, 0x00, 0x1E, 0xF8, 0xFF, 0xFF,
    0x01, 0x00, 0x23, 0x00, 0xA7, 0xF7, 0xFF, 0xFF, 0x01, 0x00, 0x24, 0x00, 0xDC, 0xF7, 0xFF, 0xFF,
    0x01, 0x00, 0x25, 0x00, 0x1D, 0x08, 0x00, 0x00, 0x01, 0x00, 0x26, 0x00, 0xA4, 0x07, 0x00, 0x00,
    0x01, 0x00, 0x27, 0x00, 0x00, 0x08, 0x00, 0x00, 0x01, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x2A, 0x00, 0xFE, 0xFF, 0xFF, 0xFF,
    0x01, 0x00, 0x2B, 0x00, 0x37, 0x00, 0x00, 0x00, 0x01, 0x00, 0x2C, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9B
  )
  x = as.raw(x)
}

